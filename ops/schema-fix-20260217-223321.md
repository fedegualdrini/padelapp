# Schema Fix: group_admins Table

## Date
2026-02-17

## Issue Summary
The `group_admins` table had a critical schema issue that broke tournament and venue admin features.

### Problems Identified

1. **Single Admin Per Group**
   - Primary key was `(group_id)` which only allowed ONE admin per group
   - This made it impossible to have multiple group administrators
   - Broke tournament and venue admin functionality for teams

2. **Incorrect Authentication Mapping**
   - `group_admins` stored `player_id` (from players table)
   - `is_group_admin()` function compared `player_id` with `auth.uid()`
   - These are **different UUIDs** - `players.id` ≠ `auth.user.id`
   - Result: RLS policies using `is_group_admin()` always returned false
   - No one could perform admin actions

3. **Missing Relationship**
   - No direct link existed between `players.id` and `auth.user.id`
   - Players are just records in the players table
   - They're not tied to specific user accounts

## Solution

### Schema Changes

**Old Schema:**
```sql
CREATE TABLE group_admins (
  group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
  player_id UUID NOT NULL REFERENCES players(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (group_id)  -- ❌ Only one admin per group
);
```

**New Schema:**
```sql
CREATE TABLE group_admins (
  group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
  user_id UUID NOT NULL,  -- ✅ Direct user mapping
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (group_id, user_id)  -- ✅ Multiple admins per group
);
```

### Function Changes

**Old is_group_admin():**
```sql
CREATE OR REPLACE FUNCTION is_group_admin(group_uuid UUID)
RETURNS BOOLEAN AS $$
  SELECT EXISTS (
    SELECT 1 FROM group_admins
    WHERE group_id = group_uuid AND player_id = auth.uid()  -- ❌ Wrong comparison
  );
$$ LANGUAGE SQL STABLE;
```

**New is_group_admin():**
```sql
CREATE OR REPLACE FUNCTION is_group_admin(group_uuid UUID)
RETURNS BOOLEAN AS $$
  SELECT EXISTS (
    SELECT 1 FROM group_admins
    WHERE group_id = group_uuid AND user_id = auth.uid()  -- ✅ Correct comparison
  );
$$ LANGUAGE SQL STABLE;
```

### Helper Functions Added

1. **promote_group_admin(group_id, user_id)** - Promote a user to admin
2. **demote_group_admin(group_id, user_id)** - Remove admin privileges
3. **check_group_admin(group_id)** - Check if current user is admin

All functions run with `SECURITY DEFINER` and appropriate grants.

## RLS Policies Updated

The following policies were updated to use the fixed `is_group_admin()` function:

1. `Group admins can create tournaments` (tournaments INSERT)
2. `Tournament creator or admins can update tournaments` (tournaments UPDATE)
3. `Tournament creator or admins can add participants` (tournament_participants INSERT)
4. `Tournament creator or admins can update tournament match status` (tournament_matches UPDATE)

## Migration Details

**File:** `supabase/migrations/20260217_230001_fix_group_admins_schema.sql`

**Steps:**
1. Drop old `group_admins` table
2. Create new table with correct schema
3. Add index for performance
4. Enable RLS and set up policies
5. Fix `is_group_admin()` function
6. Update tournament RLS policies
7. Add helper functions for admin management
8. Set up appropriate grants

**Data Loss Warning:**
- Existing `group_admins` data was NOT preserved
- There was no reliable way to map `player_id` to `user_id`
- Admins need to be reconfigured after this migration

## Testing

### Test Plan

1. **Run database reset:**
   ```bash
   supabase db reset
   ```

2. **Verify table structure:**
   ```sql
   \d group_admins
   -- Should show: Primary key: (group_id, user_id)
   ```

3. **Verify is_group_admin() works:**
   ```sql
   -- Create a test group and add an admin
   SELECT promote_group_admin('test-group-id', 'test-user-id');
   -- Should return TRUE

   -- Check admin status
   SELECT is_group_admin('test-group-id');
   -- Should return TRUE when authenticated as test-user-id
   ```

4. **Test multiple admins per group:**
   ```sql
   -- Add two admins to the same group
   SELECT promote_group_admin('test-group-id', 'user-1');
   SELECT promote_group_admin('test-group-id', 'user-2');

   -- Both should be admins
   SELECT * FROM group_admins WHERE group_id = 'test-group-id';
   -- Should return 2 rows
   ```

5. **Test tournament creation by admin:**
   ```sql
   -- As an admin, try to create a tournament
   INSERT INTO tournaments (group_id, name, created_by)
   VALUES ('test-group-id', 'Test Tournament', 'test-user-id');
   -- Should succeed
   ```

6. **Test tournament creation by non-admin:**
   ```sql
   -- As a regular member (not admin), try to create a tournament
   INSERT INTO tournaments (group_id, name, created_by)
   VALUES ('test-group-id', 'Test Tournament', 'regular-user-id');
   -- Should fail with permission error
   ```

### Expected Results

✅ Multiple admins can be added to a single group
✅ `is_group_admin()` returns correct results based on `auth.uid()`
✅ Tournament RLS policies work correctly
✅ Admins can create/update tournaments
✅ Non-admins cannot create tournaments
✅ Helper functions work correctly

## Impact Analysis

### Breaking Changes
- **High Impact** - All existing group admin configurations are lost
- Admins must be reconfigured after migration
- Apps relying on old admin checks will break

### Benefits
- **Multiple admins per group** - Teams can have multiple administrators
- **Correct authentication** - RLS policies now work as intended
- **Helper functions** - Easy admin management API
- **Future-proof** - Scalable admin system

### Areas Affected
1. Tournament creation and management
2. Venue management (if re-enabled)
3. Any future features requiring group admin permissions
4. WhatsApp bot admin commands (if any)

## Post-Migration Actions

### Required
1. **Reconfigure group admins** using the new helper functions:
   ```sql
   SELECT promote_group_admin('group-id', 'user-id');
   ```

2. **Update application code** if any directly referenced the old schema:
   - Change `player_id` to `user_id` in admin-related queries
   - Use new helper functions instead of direct table inserts

3. **Test tournament features** with configured admins:
   - Create tournaments
   - Update tournament settings
   - Manage tournament participants

### Recommended
1. **Document admin assignment process** for each group
2. **Consider adding UI** for admin management (promote/demote)
3. **Add audit logging** for admin changes
4. **Consider adding admin roles** (e.g., super admin, moderator)

## Related Issues
- **PR #15** - DB Performance Indexes (added index on group_admins that is now replaced)
- **Venues RLS Migration** - Temporarily worked around the issue by allowing all group members
- **Tournament RLS Migration** - Created policies that didn't work due to this bug

## References
- Original schema: `supabase/migrations/20260126_000001_attendance_planning.sql`
- Tournament RLS: `supabase/migrations/20260130_000005_tournaments_rls_policies.sql`
- Venues RLS: `supabase/migrations/20260202_000003_venues_rls_group_members.sql`
- Performance indexes: `supabase/migrations/20260217_000001_additional_db_performance_indexes.sql`

## Author
Chris (Backend Specialist)

## Review Status
- [x] Migration created
- [ ] Code review
- [ ] Testing completed
- [ ] Merge to main
